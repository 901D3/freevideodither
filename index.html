<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1" />
    <title>Free Video Dithering</title>
    <meta name="description" content="A tool for dither video instead of image" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/unifont@5.1.0/index.min.css" />
    <script src="https://unpkg.com/default-passive-events"></script>
  </head>
  <body class="display-flex top-bottom-flow" style="gap: 8px">
    <div class="display-flex top-bottom-flow" style="gap: 15px">
      <span
        class="glowfire text-align-center vertical-align-top-margin color font-weight-bold"
        style="font-size: 175px"
        data-text="$title"></span>
      <span class="text-align-center font-weight-bold" style="font-size: 25px" data-text="$subtitle"></span>
      <div class="firehr"></div>
    </div>
    <div class="display-flex left-right-flow width-fit-content" style="gap: 15px">
      <div class="display-flex top-bottom-flow" style="gap: 12px">
        <span class="font-weight-bold" style="font-size: 20px" data-text="$upload"></span>
        <input
          type="file"
          id="uploadFile"
          class="height-fit-content"
          title=".mp4, .mov, .mpeg, .webm, .3gp, .3gp2, .ogm, .ogv"
          accept=".mp4, .mov, .mpeg, .webm, .3gp, .3gp2, .ogm, .ogv" />
        <input type="text" id="linkUrl" placeholder="Video link(must point to a video file)" />
        <button onclick="video.src = gId('linkUrl').value;" data-text="$update"></button>
      </div>
      <div class="display-flex top-bottom-flow width-fit-content" style="gap: 12px">
        <span class="font-weight-bold" style="font-size: 20px" data-text="$recorder_renderer"></span>
        <div class="settings_checkbox-label">
          <input
            type="checkbox"
            id="streamlinedRenderOption"
            onchange="streamlinedRenderOption = document.getElementById('streamlinedRenderOption').checked" />
          <span>Streamlined</span>
        </div>
        <div class="display-flex left-right-flow width-fit-content" style="gap: 12px">
          <button id="startRecording" class="sqrButton" type="button">
            <div class="horizontal-align-center vertical-align-center-margin record"></div>
          </button>
          <button id="stopRecording" class="sqrButton" type="button" disabled="">
            <div class="horizontal-align-center vertical-align-center-margin stopRecord"></div>
          </button>
          <!--<span class="vertical-align-center-margin">[F1] [SHIFT + F1]</span>-->
          <button id="startRendering" type="button" class="sqrButton">
            <div>|-></div>
          </button>
          <button id="stopRendering" class="sqrButton" type="button" disabled="">
            <div>stop render-ing</div>
          </button>
        </div>
        <div class="display-flex left-right-flow width-fit-content" style="gap: 12px">
          <button id="pauseRecording" class="sqrButton" disabled="" type="button">
            <div
              class="horizontal-align-center width-fit-content height-fit-content display-flex left-right-flow"
              style="gap: 6px">
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #fff"></div>
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #fff"></div>
            </div>
          </button>
          <button id="resumeRecording" class="sqrButton" type="button" disabled="">
            <div>resume</div>
          </button>
          <button id="pauseRendering" class="sqrButton" disabled="" type="button">
            <div
              class="horizontal-align-center width-fit-content height-fit-content display-flex left-right-flow"
              style="gap: 6px">
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #f70"></div>
              <div class="vertical-align-center-margin" style="width: 5px; height: 16px; background-color: #f70"></div>
            </div>
          </button>
          <button id="resumeRendering" class="sqrButton" type="button" disabled="">
            <div>resume</div>
          </button>
          <!--<span class="vertical-align-center-margin">[F4]</span>-->
        </div>
      </div>
      <div class="settings_container">
        <div class="settings_label-input_long">
          <span data-text="$start_position"></span>
          <input id="rendererStartPosition" value="" placeholder="In seconds" />
        </div>
      </div>
      <div class="settings_container">
        <div class="settings_label-input_long">
          <span data-text="$mime_type"></span>
          <input id="recorderMimeTypeInput" placeholder="video/webm" value="video/webm" title="MediaRecorder MIME type" />
        </div>
        <div class="settings_label-input_long">
          <span data-text="$codec"></span>
          <input id="recorderCodecInput" placeholder="vp9" value="vp9" title="MediaRecorder codec" />
        </div>
        <div class="settings_label-slider-input">
          <span data-text="$frame_rate"></span>
          <input
            type="range"
            id="recorderFrameRateRange"
            min="0"
            max="120"
            step="0.00000000001"
            title="MediaRecorder frame rate" />
          <input type="number" id="recorderFrameRateInput" value="30" />
        </div>
        <div class="settings_label-slider-input">
          <span data-text="$bitrate"></span>
          <input type="range" id="recorderVideoBitrateRange" min="0" max="100000000" step="1" />
          <input type="number" id="recorderVideoBitrateInput" value="20000000" />
        </div>
        <div class="settings_label-input_long">
          <span data-text="$file_name"></span>
          <input id="recorderFileName" value="" title="MediaRecorder output file name" />
        </div>
      </div>
      <div class="settings_container">
        <span>Render specific</span>
        <div class="settings_label-slider-input">
          <span data-text="$blob_quality"></span>
          <input type="range" id="blobQualityRange" min="0" max="1" step="0.00000000001" />
          <input type="number" id="blobQualityInput" value="0.90" />
        </div>
        <div class="settings_label-select">
          <span data-text="$codec"></span>
          <select id="renderCodec">
            <option value="vp8">vp8</option>
            <option value="vp09">vp09</option>
          </select>
        </div>
        <div class="settings_label-slider-input">
          <span>Buffer size(keyframe interval)</span>
          <input type="number" id="bufferSizeInput" value="30" />
        </div>
        <div class="settings_label-input">
          <span data-text="$max_concurrent_encodes"></span>
          <input type="number" id="rendererMaxConcurrentEncodes" value="2" />
        </div>
      </div>
    </div>
    <div class="bigContainer left-right-flow" style="gap: 20px">
      <div class="controls">
        <div class="settings_container">
          <div class="settings_label-select">
            <h2>Dither</h2>
            <select id="dither">
              <option value="none" selected="selected">None</option>
              <option value="matrixThreshold" data-text="$matrix_thresh"></option>
              <option value="arithmetic" data-text="$arithmetic"></option>
              <option value="errDiffs" data-text="$err_diffs"></option>
              <option value="varErrDiffs" data-text="$var_err_diffs"></option>
            </select>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$matrix_thresh"></span>
            <select id="matrix" class="disabled">
              <option value="threshold">Threshold</option>
              <option value="bayer2">Bayer 2²</option>
              <option value="bayer4">Bayer 4²</option>
              <option value="bayer8">Bayer 8²</option>
              <option value="bayer16">Bayer 16²</option>
              <option value="bayer32">Bayer 32²</option>
              <option value="bayer64">Bayer 64²</option>
              <option value="bayer128">Bayer 128²</option>
              <option value="bayer256">Bayer 256²</option>
              <option value="bayer512">Bayer 512²</option>
              <option value="blueNoise">Blue Noise</option>
            </select>
          </div>
          <div id="matrixThreshDisp" class="settings_container disabled">
            <textarea id="matrixInput" placeholder="2D matrix only"></textarea>
            <input id="divisionInput" type="number" value="2" />
            <div class="settings_checkbox-label">
              <input type="checkbox" id="autoDiv" checked="" />
              <span>Auto</span>
            </div>
          </div>
          <div id="blueNoiseDisp" class="settings_container disabled">
            <canvas id="blueNoiseCanvas" data-text="$elN_A" style="border: 3px solid #ff0"></canvas>
            <textarea id="blueNoiseInitArrayInput" placeholder="Custom initial binary array. 2D array only"></textarea>
            <div class="display-flex left-right-flow">
              <textarea
                type="number"
                id="blueNoisePhase1Kernel"
                placeholder="Phase 1 kernel"
                style="width: 150px; height: 150px"></textarea>
              <textarea
                type="number"
                id="blueNoisePhase2Kernel"
                placeholder="Phase 2 kernel"
                style="width: 150px; height: 150px"></textarea>
              <textarea
                type="number"
                id="blueNoisePhase3Kernel"
                placeholder="Phase 3 kernel"
                style="width: 150px; height: 150px"></textarea>
            </div>
            <div class="settings_label-input">
              <span data-text="$width"></span>
              <input type="number" id="blueNoiseWidth" value="64" />
            </div>
            <div class="settings_label-input">
              <span data-text="$height"></span>
              <input type="number" id="blueNoiseHeight" value="64" />
            </div>
            <div class="settings_label-input">
              <span>PDS radius x</span>
              <input type="number" id="blueNoisePDSRadiusX" value="8" />
            </div>
            <div class="settings_label-input">
              <span>PDS radius y</span>
              <input type="number" id="blueNoisePDSRadiusY" value="8" />
            </div>
            <div class="settings_label-input">
              <span>PDS k value</span>
              <input type="number" id="blueNoisePDSKValue" value="30" />
            </div>
            <div class="settings_label-input">
              <span>Phase 1 sigma</span>
              <input type="number" id="blueNoisePhase1Sigma" value="6" />
            </div>
            <div class="settings_label-input">
              <span>Phase 2 sigma</span>
              <input type="number" id="blueNoisePhase2Sigma" value="2" />
            </div>
            <div class="settings_label-input">
              <span>Phase 3 sigma</span>
              <input type="number" id="blueNoisePhase3Sigma" value="2" />
            </div>
            <div class="settings_label-input">
              <span>Candidate filling ratio</span>
              <input type="number" id="blueNoiseCandidateFillingRatio" value="0.5" />
            </div>
            <button onclick="setTimeout(blueNoiseWrapper, 0)">Generate</button>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$arithmetic"></span>
            <select id="arithmetic" class="disabled">
              <option value="arithmeticAdd" data-text="$arithmetic_add"></option>
              <option value="arithmeticAddConvariant" data-text="$arithmetic_add_conv"></option>
              <option value="arithmeticXor" data-text="$arithmetic_xor"></option>
              <option value="arithmeticXorConvariant" data-text="$arithmetic_xor_conv"></option>
              <option value="halftone" data-text="$halftone"></option>
              <option value="colorShiftedHalftone" data-text="$color_shifted"></option>
            </select>
          </div>
          <div id="arithmeticDisp" class="settings_container disabled">
            <textarea id="arithmeticInput" placeholder="'x', 'y', 'c'"></textarea>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$err_diffs"></span>
            <select id="errDiffs" class="disabled">
              <option value="floydSteinberg">Floyd-Steinberg</option>
              <option value="falseFloydSteinberg">False Floyd-Steinberg</option>
              <option value="fan">Fan</option>
              <option value="shiauFan">Shiau-Fan</option>
              <option value="shiauFan2">Shiau-Fan 2</option>
              <option value="atkinson">Atkinson</option>
              <option value="burkes">Burkes</option>
              <option value="javisJudiceNinke">Jarvis-Judice-Ninke</option>
              <option value="stucki">Stucki</option>
              <option value="sierra">Sierra</option>
              <option value="sierraLite">Sierra Lite</option>
              <option value="sierra2">Sierra 2</option>
              <option value="box">Box</option>
              <option value="diagonal">Diagonal</option>
              <option value="pigeon">Steve Pigeon</option>
              <option value="kist">Robert Kist</option>
              <option value="arce">Stevenson Arce</option>
              <option value="xot">Xot(Perf Warning)</option>
              <option value="twoD">Two-Dim</option>
              <option value="oneD">One-Dim</option>
            </select>
          </div>
          <div id="errDiffsInputDisp" class="settings_container disabled">
            <textarea id="errDiffsMatrixInput" placeholder="2D matrix only"></textarea>
            <input id="errDiffsDivisionInput" type="number" />
            <div class="settings_checkbox-label">
              <input type="checkbox" id="errDiffsAutoDiv" checked="" />
              <span>Auto</span>
            </div>
          </div>
          <div id="errLvlsDisp" class="settings_container disabled">
            <div class="settings_label-slider-input" style="background-color: #ff0000; border-radius: 2px">
              <span>Red Diffuse</span>
              <input type="range" id="rErrLvlsRange" min="0" max="1" step="0.00000000001" />
              <input type="number" id="rErrLvlsInput" value="1" />
            </div>
            <div class="settings_label-slider-input" style="background-color: #00ff00; border-radius: 2px">
              <span>Green Diffuse</span>
              <input type="range" id="gErrLvlsRange" min="0" max="1" step="0.00000000001" />
              <input type="number" id="gErrLvlsInput" value="1" />
            </div>
            <div class="settings_label-slider-input" style="background-color: #0000ff; border-radius: 2px">
              <span>Blue Diffuse</span>
              <input type="range" id="bErrLvlsRange" min="0" max="1" step="0.00000000001" />
              <input type="number" id="bErrLvlsInput" value="1" />
            </div>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-select">
            <span data-text="$var_err_diffs"></span>
            <select id="varErrDiffs" class="disabled">
              <option value="ostromoukhov">Ostromoukhov</option>
              <!--<option value="zhouFang">ZhouFang</option>-->
            </select>
          </div>
          <div id="varErrDiffsInputDisp" class="settings_container disabled">
            <textarea id="varErrDiffsMatrixInput" placeholder="3D + 1 matrix"></textarea>
          </div>
          <div id="mirrorDisp" class="settings_checkbox-label disabled">
            <input type="checkbox" id="useMirror" checked="" />
            <span data-text="$mirror"></span>
          </div>
          <div class="whitehr"></div>
          <div id="serpentineDisp" class="settings_checkbox-label disabled">
            <input type="checkbox" id="useSerpentine" />
            <span data-text="$serpentine"></span>
          </div>
          <div id="bufferDisp" class="settings_checkbox-label-select disabled">
            <input type="checkbox" id="useBuffer" />
            <span data-text="$buffer"></span>
            <div id="bufferSelectDisp" class="disabled">
              <select id="buffer">
                <option value="Int8Array" selected="" data-text="$Int8Array"></option>
                <option value="Int16Array" data-text="$Int16Array"></option>
                <option value="Int32Array" data-text="$Int32Array"></option>
                <option value="Float16Array" data-text="$Float16Array"></option>
                <option value="Float32Array" data-text="$Float32Array"></option>
                <option value="Float64Array" data-text="$Float64Array"></option>
              </select>
            </div>
          </div>
          <div class="whitehr"></div>
          <div id="lvlsDisp" class="settings_container disabled">
            <div class="settings_label-slider-input" style="background-color: #ff0000; border-radius: 2px">
              <span></span>
              <input type="range" id="rLvlsRange" min="2" max="255" step="0.00000000001" />
              <input type="number" id="rLvlsInput" value="2" />
            </div>
            <div class="settings_label-slider-input" style="background-color: #00ff00; border-radius: 2px">
              <span></span>
              <input type="range" id="gLvlsRange" min="2" max="255" step="0.00000000001" />
              <input type="number" id="gLvlsInput" value="2" />
            </div>
            <div class="settings_label-slider-input" style="background-color: #0000ff; border-radius: 2px">
              <span></span>
              <input type="range" id="bLvlsRange" min="2" max="255" step="0.00000000001" />
              <input type="number" id="bLvlsInput" value="2" />
            </div>
          </div>
          <div id="linearDisp" class="settings_checkbox-label">
            <input type="checkbox" id="useLinear" title="Linear color space" />
            <span data-text="$linear"></span>
          </div>
          <div class="whitehr"></div>
          <div class="settings_label-slider-input">
            <span data-text="$frame_rate_cap"></span>
            <input type="range" id="frameRateRange" min="0" max="120" step="0.00000000001" />
            <input type="number" id="frameRateInput" value="30" title="Preview frame rate" />
          </div>
          <div class="whitehr"></div>
          <div class="settings_container">
            <h2>Canvas</h2>
            <div class="settings_label-input">
              <span>Width</span>
              <input type="number" id="canvasWidth" value="480" />
            </div>
            <div class="settings_label-input">
              <span>Height</span>
              <input type="number" id="canvasHeight" value="270" />
            </div>
            <button onclick="changeCanvasSize()" data-text="$change_canvas_size"></button>
            <div class="settings_checkbox-label">
              <input
                type="checkbox"
                id="canvasRendering"
                checked=""
                oninput="gId('canvas').style.imageRendering=canvasRendering.checked?'pixelated':'normal'" />
              <span>Pixelated Rendering</span>
            </div>
            <div class="settings_checkbox-label">
              <input type="checkbox" id="desyncOpt" />
              <span>Canvas Desynchronize</span>
            </div>
            <button onclick="fullscreenCanvas()">Canvas fullscreen</button>
          </div>
        </div>
      </div>
      <div class="previewContainer">
        <div class="mainVideo">
          <video
            id="video"
            width="480"
            height="270"
            src="gradient.mp4"
            controls
            loop
            crossorigin="anonymous"
            data-text="$elN_A"></video>
        </div>
        <div class="firehr"></div>
        <div class="mainCanvas">
          <canvas id="canvas" width="480" height="270" data-text="$elN_A"></canvas>
        </div>
      </div>
    </div>
    <div class="settings_checkbox-label">
      <input type="checkbox" id="showTelemetry" oninput="t = gId('showTelemetry').checked" />
      <span data-text="$telemetry"></span>
    </div>
    <div class="border-style-solid" style="border-width: 2px; border-color: #1070ea">
      <div id="console"></div>
    </div>
    <div class="firehr"></div>
  </body>
  <script src="scripts/init.js"></script>

  <!--Resources-->
  <script src="scripts/resources/varErrDiffsRsrc.base.js"></script>
  <script src="scripts/resources/varErrDiffsRsrc.ostromoukhov.js"></script>
  <!--<script src="scripts/resources/varErrDiffsRsrc.zhouFang.js"></script>-->

  <!--Libraries-->
  <script src="scripts/lib/901D3/binUtils.js"></script>
  <script src="scripts/lib/901D3/blue-noise-utils.js"></script>
  <script src="scripts/lib/901D3/blue-noise-float32.js"></script>
  <script src="scripts/lib/901D3/WebM-muxer.js"></script>

  <script src="scripts/locale.js"></script>
  <script src="scripts/generator.js"></script>
  <script src="scripts/sizing.js"></script>
  <script src="scripts/videocontrols.js"></script>
  <script src="scripts/dither.js"></script>
  <script src="scripts/misc.js"></script>
  <script src="scripts/process.js"></script>
  <script src="scripts/recorder.js"></script>
  <script>
    gId("uploadFile").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (file) {
        const videoURL = URL.createObjectURL(file);
        video.src = videoURL;
        video.load();
        printLog(`Video src: ${videoURL}`);
        gId("startRecording").removeAttribute("disabled");
        gId("startRendering").removeAttribute("disabled");
      }
    });

    document.addEventListener("keydown", function (event) {
      var activeElement = document.activeElement.tagName.toLowerCase();
      if (event.code === "KeyR" && activeElement !== "input" && activeElement !== "textarea") {
        processFrame();
      } else if (event.code === "KeyF" && activeElement !== "input" && activeElement !== "textarea") fullscreenCanvas();
    });

    gId("canvasRendering").addEventListener("change", function () {
      var currentStyle = canvas.getAttribute("style");
      if (gId("canvasRendering").checked) {
        if (currentStyle) {
          canvas.setAttribute("style", currentStyle + "; image-rendering: pixelated");
        } else {
          canvas.setAttribute("style", "image-rendering: pixelated");
        }
      } else {
        if (currentStyle) {
          canvas.setAttribute("style", currentStyle.replace(/;?\s*image-rendering:\s*pixelated/g, "").trim());
        }
      }
    });
  </script>
</html>
